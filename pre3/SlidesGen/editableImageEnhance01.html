<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enhanced Diagram Editor — UpANNS</title>
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root { --panel-w: 290px; }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'Source Sans Pro',system-ui,sans-serif; background:#f0f2f5; display:flex; flex-direction:column; height:100vh; overflow:hidden; }

  /* ── Toolbar ── */
  #toolbar { display:flex; align-items:center; gap:6px; padding:6px 12px; background:#1e293b; color:#fff; box-shadow:0 2px 6px rgba(0,0,0,.25); z-index:10; flex-wrap:wrap; }
  #toolbar .title { font-size:14px; font-weight:600; margin-right:auto; white-space:nowrap; }
  .tb-btn { padding:5px 10px; border:none; border-radius:4px; font-size:12px; font-weight:600; cursor:pointer; transition:background .15s; white-space:nowrap; }
  .tb-btn.primary { background:#3b82f6; color:#fff; }
  .tb-btn.primary:hover { background:#2563eb; }
  .tb-btn.sec { background:#475569; color:#e2e8f0; }
  .tb-btn.sec:hover { background:#64748b; }
  .tb-btn.danger { background:#ef4444; color:#fff; }
  .tb-btn.danger:hover { background:#dc2626; }
  .tb-btn.tool { background:#334155; color:#94a3b8; font-size:15px; min-width:30px; text-align:center; padding:4px 7px; }
  .tb-btn.tool:hover { background:#475569; color:#fff; }
  .tb-btn.tool.active { background:#3b82f6; color:#fff; }
  .tb-btn[disabled] { opacity:.35; pointer-events:none; }
  .tb-sep { width:1px; height:22px; background:#475569; flex-shrink:0; }
  .tb-label { font-size:11px; color:#94a3b8; }
  #zoom-display { font-size:11px; color:#94a3b8; min-width:40px; text-align:center; }

  /* ── Layout ── */
  #main { display:flex; flex:1; overflow:hidden; }
  #canvas-wrap { flex:1; overflow:auto; padding:16px; display:flex; justify-content:center; align-items:flex-start; }
  #canvas { background:#fff; box-shadow:0 4px 20px rgba(0,0,0,.12); border-radius:8px; padding:8px; max-width:1340px; width:100%; }
  #canvas svg { cursor:default; display:block; }
  svg text { font-family:'Source Sans Pro','Times New Roman',serif; }

  /* ── Properties panel ── */
  #panel { width:var(--panel-w); min-width:var(--panel-w); background:#1e293b; color:#e2e8f0; padding:14px; overflow-y:auto; font-size:13px; border-left:1px solid #334155; }
  #panel h2 { font-size:13px; margin-bottom:10px; color:#94a3b8; text-transform:uppercase; letter-spacing:.5px; }
  .empty-msg { color:#64748b; font-style:italic; margin-top:16px; line-height:1.6; }
  .prop-row { margin-bottom:8px; }
  .prop-row label { display:block; font-size:11px; color:#94a3b8; margin-bottom:2px; text-transform:uppercase; }
  .prop-row input[type="text"], .prop-row input[type="number"], .prop-row textarea {
    width:100%; padding:4px 7px; border:1px solid #475569; border-radius:4px; background:#0f172a; color:#e2e8f0; font-size:12px; }
  .prop-row textarea { min-height:40px; resize:vertical; font-family:inherit; }
  .prop-row input[type="color"] { width:32px; height:24px; border:1px solid #475569; border-radius:4px; cursor:pointer; background:none; padding:1px; }
  .color-group { display:flex; align-items:center; gap:6px; }
  .color-hex { font-family:monospace; font-size:11px; color:#94a3b8; }
  .inline { display:flex; gap:4px; align-items:center; }
  .inline input { flex:1; }
  .prop-apply { padding:3px 10px; border:none; border-radius:3px; background:#3b82f6; color:#fff; cursor:pointer; font-size:11px; font-weight:600; }
  .prop-apply:hover { background:#2563eb; }
  .prop-row input[type="range"] { width:100%; accent-color:#3b82f6; }

  /* ── Inline text editor ── */
  #text-editor { position:fixed; z-index:100; display:none; background:#fff; border:2px solid #3b82f6; border-radius:4px; padding:3px 5px; box-shadow:0 4px 12px rgba(0,0,0,.2); min-width:60px; }
  #text-editor input { border:none; outline:none; font-size:14px; width:100%; min-width:50px; background:transparent; }

  /* ── Toast ── */
  #toast { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#1e293b; color:#e2e8f0; padding:8px 18px; border-radius:6px; font-size:13px; box-shadow:0 4px 12px rgba(0,0,0,.3); opacity:0; transition:opacity .3s; pointer-events:none; z-index:200; }
  #toast.show { opacity:1; }

  /* ── Resize handle cursors (set via JS) ── */
  .resize-handle { pointer-events:all; }
</style>
</head>
<body>

<!-- ═══════════ Toolbar ═══════════ -->
<div id="toolbar">
  <span class="title">Diagram Editor</span>
  <button class="tb-btn tool" onclick="undo()" title="Undo (Ctrl+Z)" id="btn-undo" disabled>&#x21A9;</button>
  <button class="tb-btn tool" onclick="redo()" title="Redo (Ctrl+Y)" id="btn-redo" disabled>&#x21AA;</button>
  <div class="tb-sep"></div>
  <button class="tb-btn tool" onclick="deleteSelected()" title="Delete (Del)" id="btn-del" disabled>&#x1F5D1;</button>
  <button class="tb-btn tool" onclick="duplicateSelected()" title="Duplicate (Ctrl+D)" id="btn-dup" disabled>&#x2398;</button>
  <div class="tb-sep"></div>
  <button class="tb-btn tool" onclick="addMode='text'" title="Add Text" id="btn-addtext">T</button>
  <button class="tb-btn tool" onclick="addMode='rect'" title="Add Rectangle" id="btn-addrect">&#x25AD;</button>
  <div class="tb-sep"></div>
  <button class="tb-btn tool" onclick="setZoom(zoomLevel+.25)" title="Zoom In">+</button>
  <span id="zoom-display">100%</span>
  <button class="tb-btn tool" onclick="setZoom(zoomLevel-.25)" title="Zoom Out">&minus;</button>
  <button class="tb-btn tool" onclick="setZoom(1)" title="Fit to view">&#x21C6;</button>
  <div class="tb-sep"></div>
  <button class="tb-btn primary" onclick="downloadHTML()">Download HTML</button>
  <button class="tb-btn primary" onclick="downloadSVG()">Download SVG</button>
  <div class="tb-sep"></div>
  <button class="tb-btn danger" onclick="resetAll()">Reset</button>
</div>

<!-- ═══════════ Main area ═══════════ -->
<div id="main">
<div id="canvas-wrap">
<div id="canvas">
<svg id="diagram" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1300 560" width="100%">
  <defs>
    <marker id="arrowBlack" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><path d="M0,0 L8,3 L0,6 Z" fill="#444"/></marker>
    <marker id="arrowBlackSmall" markerWidth="6" markerHeight="5" refX="6" refY="2.5" orient="auto"><path d="M0,0 L6,2.5 L0,5 Z" fill="#444"/></marker>
    <linearGradient id="blueBoxBg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#d6e8f7"/><stop offset="100%" stop-color="#c4ddf0"/></linearGradient>
    <linearGradient id="blueBoxBg2" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#d0e4f4"/><stop offset="100%" stop-color="#bdd8ee"/></linearGradient>
    <symbol id="dpuChip" viewBox="0 0 36 36"><rect x="8" y="8" width="20" height="20" rx="2" fill="#2a6496" stroke="#1a4a72" stroke-width="1"/><rect x="12" y="12" width="12" height="12" rx="1" fill="#3a7ab8"/><line x1="12" y1="8" x2="12" y2="3" stroke="#1a4a72" stroke-width="1.5"/><line x1="18" y1="8" x2="18" y2="3" stroke="#1a4a72" stroke-width="1.5"/><line x1="24" y1="8" x2="24" y2="3" stroke="#1a4a72" stroke-width="1.5"/><line x1="12" y1="28" x2="12" y2="33" stroke="#1a4a72" stroke-width="1.5"/><line x1="18" y1="28" x2="18" y2="33" stroke="#1a4a72" stroke-width="1.5"/><line x1="24" y1="28" x2="24" y2="33" stroke="#1a4a72" stroke-width="1.5"/><line x1="8" y1="12" x2="3" y2="12" stroke="#1a4a72" stroke-width="1.5"/><line x1="8" y1="18" x2="3" y2="18" stroke="#1a4a72" stroke-width="1.5"/><line x1="8" y1="24" x2="3" y2="24" stroke="#1a4a72" stroke-width="1.5"/><line x1="28" y1="12" x2="33" y2="12" stroke="#1a4a72" stroke-width="1.5"/><line x1="28" y1="18" x2="33" y2="18" stroke="#1a4a72" stroke-width="1.5"/><line x1="28" y1="24" x2="33" y2="24" stroke="#1a4a72" stroke-width="1.5"/></symbol>
  </defs>

  <!-- ==================== OFFLINE ==================== -->
  <text x="72" y="25" font-size="14" font-weight="700" text-anchor="middle" fill="#1a1a1a">Encoded points</text>
  <text x="18" y="50" font-size="11.5" font-style="italic" fill="#333">Vector 0</text>
  <g transform="translate(75,36)"><rect x="0" y="0" width="12" height="12" fill="#8fc48a" stroke="#aaa" stroke-width="0.5"/><rect x="13" y="0" width="12" height="12" fill="#e8c98a" stroke="#aaa" stroke-width="0.5"/><rect x="26" y="0" width="12" height="12" fill="#bbb" stroke="#aaa" stroke-width="0.5"/><rect x="39" y="0" width="12" height="12" fill="#8fc48a" stroke="#aaa" stroke-width="0.5"/><rect x="52" y="0" width="12" height="12" fill="#bbb" stroke="#aaa" stroke-width="0.5"/><rect x="65" y="0" width="12" height="12" fill="#e8c98a" stroke="#aaa" stroke-width="0.5"/><rect x="78" y="0" width="12" height="12" fill="#8fc48a" stroke="#aaa" stroke-width="0.5"/><rect x="91" y="0" width="12" height="12" fill="#e8c98a" stroke="#aaa" stroke-width="0.5"/></g>
  <text x="18" y="67" font-size="11.5" font-style="italic" fill="#333">Vector 1</text>
  <g transform="translate(75,53)"><rect x="0" y="0" width="12" height="12" fill="#e8c98a" stroke="#aaa" stroke-width="0.5"/><rect x="13" y="0" width="12" height="12" fill="#bbb" stroke="#aaa" stroke-width="0.5"/><rect x="26" y="0" width="12" height="12" fill="#8fc48a" stroke="#aaa" stroke-width="0.5"/><rect x="39" y="0" width="12" height="12" fill="#bbb" stroke="#aaa" stroke-width="0.5"/><rect x="52" y="0" width="12" height="12" fill="#e8c98a" stroke="#aaa" stroke-width="0.5"/><rect x="65" y="0" width="12" height="12" fill="#8fc48a" stroke="#aaa" stroke-width="0.5"/><rect x="78" y="0" width="12" height="12" fill="#bbb" stroke="#aaa" stroke-width="0.5"/><rect x="91" y="0" width="12" height="12" fill="#e8c98a" stroke="#aaa" stroke-width="0.5"/></g>
  <text x="18" y="84" font-size="11.5" font-style="italic" fill="#333">Vector 2</text>
  <g transform="translate(75,70)"><rect x="0" y="0" width="12" height="12" fill="#bbb" stroke="#aaa" stroke-width="0.5"/><rect x="13" y="0" width="12" height="12" fill="#8fc48a" stroke="#aaa" stroke-width="0.5"/><rect x="26" y="0" width="12" height="12" fill="#e8c98a" stroke="#aaa" stroke-width="0.5"/><rect x="39" y="0" width="12" height="12" fill="#8fc48a" stroke="#aaa" stroke-width="0.5"/><rect x="52" y="0" width="12" height="12" fill="#bbb" stroke="#aaa" stroke-width="0.5"/><rect x="65" y="0" width="12" height="12" fill="#bbb" stroke="#aaa" stroke-width="0.5"/><rect x="78" y="0" width="12" height="12" fill="#e8c98a" stroke="#aaa" stroke-width="0.5"/><rect x="91" y="0" width="12" height="12" fill="#8fc48a" stroke="#aaa" stroke-width="0.5"/></g>
  <text x="100" y="103" font-size="18" font-weight="700" fill="#333" text-anchor="middle">&#x22EE;</text>
  <text x="18" y="127" font-size="11.5" font-style="italic" fill="#333">Vector n</text>
  <g transform="translate(75,113)"><rect x="0" y="0" width="12" height="12" fill="#8fc48a" stroke="#aaa" stroke-width="0.5"/><rect x="13" y="0" width="12" height="12" fill="#8fc48a" stroke="#aaa" stroke-width="0.5"/><rect x="26" y="0" width="12" height="12" fill="#bbb" stroke="#aaa" stroke-width="0.5"/><rect x="39" y="0" width="12" height="12" fill="#e8c98a" stroke="#aaa" stroke-width="0.5"/><rect x="52" y="0" width="12" height="12" fill="#8fc48a" stroke="#aaa" stroke-width="0.5"/><rect x="65" y="0" width="12" height="12" fill="#bbb" stroke="#aaa" stroke-width="0.5"/><rect x="78" y="0" width="12" height="12" fill="#e8c98a" stroke="#aaa" stroke-width="0.5"/><rect x="91" y="0" width="12" height="12" fill="#8fc48a" stroke="#aaa" stroke-width="0.5"/></g>
  <polygon points="182,72 222,72 222,66 236,80 222,94 222,88 182,88" fill="#bbb" stroke="#999" stroke-width="0.5"/>

  <!-- Co-occurrence Aware Encoding -->
  <rect x="245" y="8" width="380" height="210" rx="6" fill="url(#blueBoxBg)" stroke="#7badd4" stroke-width="1.5"/>
  <text x="435" y="228" font-size="13" font-weight="600" text-anchor="middle" fill="#1a1a1a">Co-occurrence Aware Encoding</text>
  <rect x="320" y="16" width="160" height="32" rx="4" fill="#4a90b8" opacity="0.85"/>
  <text x="400" y="30" font-size="11" font-weight="600" text-anchor="middle" fill="white">High Frequent</text>
  <text x="400" y="43" font-size="11" font-weight="600" text-anchor="middle" fill="white">Co-occurrence</text>
  <g transform="translate(270,55)"><rect x="0" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="15" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="30" y="0" width="14" height="14" fill="#e8c98a" stroke="#bbb" stroke-width="0.5"/><rect x="45" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="60" y="0" width="14" height="14" fill="#8fc48a" stroke="#bbb" stroke-width="0.5"/><rect x="75" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="90" y="0" width="14" height="14" fill="#e8c98a" stroke="#bbb" stroke-width="0.5"/><rect x="105" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="0" y="15" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="15" y="15" width="14" height="14" fill="#8fc48a" stroke="#bbb" stroke-width="0.5"/><rect x="30" y="15" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="45" y="15" width="14" height="14" fill="#bbb" stroke="#999" stroke-width="0.5"/><rect x="60" y="15" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="75" y="15" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="90" y="15" width="14" height="14" fill="#8fc48a" stroke="#bbb" stroke-width="0.5"/><rect x="105" y="15" width="14" height="14" fill="#e8c98a" stroke="#bbb" stroke-width="0.5"/><rect x="0" y="30" width="14" height="14" fill="#e8c98a" stroke="#bbb" stroke-width="0.5"/><rect x="15" y="30" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="30" y="30" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="45" y="30" width="14" height="14" fill="#8fc48a" stroke="#bbb" stroke-width="0.5"/><rect x="60" y="30" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="75" y="30" width="14" height="14" fill="#e8c98a" stroke="#bbb" stroke-width="0.5"/><rect x="90" y="30" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="105" y="30" width="14" height="14" fill="#bbb" stroke="#999" stroke-width="0.5"/><rect x="0" y="45" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="15" y="45" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="30" y="45" width="14" height="14" fill="#8fc48a" stroke="#bbb" stroke-width="0.5"/><rect x="45" y="45" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="60" y="45" width="14" height="14" fill="#e8c98a" stroke="#bbb" stroke-width="0.5"/><rect x="75" y="45" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="90" y="45" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="105" y="45" width="14" height="14" fill="#8fc48a" stroke="#bbb" stroke-width="0.5"/><rect x="0" y="60" width="14" height="14" fill="#bbb" stroke="#999" stroke-width="0.5"/><rect x="15" y="60" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="30" y="60" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="45" y="60" width="14" height="14" fill="#e8c98a" stroke="#bbb" stroke-width="0.5"/><rect x="60" y="60" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="75" y="60" width="14" height="14" fill="#bbb" stroke="#999" stroke-width="0.5"/><rect x="90" y="60" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="105" y="60" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="0" y="75" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="15" y="75" width="14" height="14" fill="#e8c98a" stroke="#bbb" stroke-width="0.5"/><rect x="30" y="75" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="45" y="75" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="60" y="75" width="14" height="14" fill="#8fc48a" stroke="#bbb" stroke-width="0.5"/><rect x="75" y="75" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="90" y="75" width="14" height="14" fill="#e8c98a" stroke="#bbb" stroke-width="0.5"/><rect x="105" y="75" width="14" height="14" fill="#8fc48a" stroke="#bbb" stroke-width="0.5"/></g>
  <text x="420" y="130" font-size="13" font-weight="600" fill="#1a1a1a">Encode</text>
  <line x1="395" y1="100" x2="460" y2="65" stroke="#888" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/><line x1="395" y1="120" x2="460" y2="100" stroke="#888" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/><line x1="395" y1="140" x2="460" y2="135" stroke="#888" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/><line x1="395" y1="160" x2="460" y2="165" stroke="#888" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/><line x1="395" y1="175" x2="460" y2="195" stroke="#888" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <g transform="translate(465,50)"><rect x="0" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="16" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="32" y="0" width="14" height="14" fill="#e8c98a" stroke="#bbb" stroke-width="0.5"/><rect x="48" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/></g>
  <g transform="translate(465,85)"><rect x="0" y="0" width="14" height="14" fill="#8fc48a" stroke="#bbb" stroke-width="0.5"/><rect x="16" y="0" width="14" height="14" fill="#2d6b2d" stroke="#bbb" stroke-width="0.5"/><rect x="32" y="0" width="14" height="14" fill="#8fc48a" stroke="#bbb" stroke-width="0.5"/><rect x="48" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/></g>
  <g transform="translate(465,120)"><rect x="0" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="16" y="0" width="14" height="14" fill="#e8a050" stroke="#bbb" stroke-width="0.5"/><rect x="32" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/></g>
  <g transform="translate(465,155)"><rect x="0" y="0" width="14" height="14" fill="#bbb" stroke="#999" stroke-width="0.5"/><rect x="16" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/></g>
  <g transform="translate(465,185)"><rect x="0" y="0" width="14" height="14" fill="#e8c98a" stroke="#bbb" stroke-width="0.5"/></g>
  <line x1="535" y1="65" x2="570" y2="100" stroke="#888" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/><line x1="535" y1="95" x2="570" y2="105" stroke="#888" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/><line x1="530" y1="130" x2="570" y2="115" stroke="#888" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/><line x1="520" y1="165" x2="570" y2="130" stroke="#888" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/><line x1="510" y1="195" x2="570" y2="140" stroke="#888" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <g transform="translate(575,80)"><rect x="0" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="0" y="15" width="14" height="14" fill="#8fc48a" stroke="#bbb" stroke-width="0.5"/><rect x="0" y="30" width="14" height="14" fill="#2d6b2d" stroke="#bbb" stroke-width="0.5"/><rect x="0" y="45" width="14" height="14" fill="#e8a050" stroke="#bbb" stroke-width="0.5"/><rect x="0" y="60" width="14" height="14" fill="#bbb" stroke="#999" stroke-width="0.5"/><rect x="0" y="75" width="14" height="14" fill="#e8c98a" stroke="#bbb" stroke-width="0.5"/></g>
  <polygon points="630,104 670,104 670,98 684,112 670,126 670,120 630,120" fill="#bbb" stroke="#999" stroke-width="0.5"/>

  <!-- Copy & Distribute -->
  <rect x="695" y="8" width="580" height="210" rx="6" fill="url(#blueBoxBg)" stroke="#7badd4" stroke-width="1.5"/>
  <text x="985" y="28" font-size="14" font-weight="700" text-anchor="middle" fill="#1a5a8a">Copy &amp; Distribute</text>
  <g transform="translate(720,42)"><g><ellipse cx="18" cy="8" rx="14" ry="6" fill="#6ab86a" stroke="#4a8a4a" stroke-width="0.7"/><rect x="4" y="8" width="28" height="20" fill="#6ab86a"/><ellipse cx="18" cy="28" rx="14" ry="6" fill="#5aa85a" stroke="#4a8a4a" stroke-width="0.7"/><line x1="4" y1="8" x2="4" y2="28" stroke="#4a8a4a" stroke-width="0.7"/><line x1="32" y1="8" x2="32" y2="28" stroke="#4a8a4a" stroke-width="0.7"/><ellipse cx="18" cy="8" rx="14" ry="6" fill="none" stroke="#4a8a4a" stroke-width="0.7"/></g><g transform="translate(0,30)"><ellipse cx="18" cy="8" rx="14" ry="6" fill="#6ab86a" stroke="#4a8a4a" stroke-width="0.7"/><rect x="4" y="8" width="28" height="20" fill="#6ab86a"/><ellipse cx="18" cy="28" rx="14" ry="6" fill="#5aa85a" stroke="#4a8a4a" stroke-width="0.7"/><line x1="4" y1="8" x2="4" y2="28" stroke="#4a8a4a" stroke-width="0.7"/><line x1="32" y1="8" x2="32" y2="28" stroke="#4a8a4a" stroke-width="0.7"/></g></g>
  <g transform="translate(775,42)"><g><ellipse cx="18" cy="8" rx="14" ry="6" fill="#e8a050" stroke="#c07830" stroke-width="0.7"/><rect x="4" y="8" width="28" height="20" fill="#e8a050"/><ellipse cx="18" cy="28" rx="14" ry="6" fill="#d89040" stroke="#c07830" stroke-width="0.7"/><line x1="4" y1="8" x2="4" y2="28" stroke="#c07830" stroke-width="0.7"/><line x1="32" y1="8" x2="32" y2="28" stroke="#c07830" stroke-width="0.7"/><ellipse cx="18" cy="8" rx="14" ry="6" fill="none" stroke="#c07830" stroke-width="0.7"/></g><g transform="translate(0,30)"><ellipse cx="18" cy="8" rx="14" ry="6" fill="#e8a050" stroke="#c07830" stroke-width="0.7"/><rect x="4" y="8" width="28" height="20" fill="#e8a050"/><ellipse cx="18" cy="28" rx="14" ry="6" fill="#d89040" stroke="#c07830" stroke-width="0.7"/><line x1="4" y1="8" x2="4" y2="28" stroke="#c07830" stroke-width="0.7"/><line x1="32" y1="8" x2="32" y2="28" stroke="#c07830" stroke-width="0.7"/></g></g>
  <g transform="translate(830,42)"><g><ellipse cx="18" cy="8" rx="14" ry="6" fill="#e8d86a" stroke="#b8a840" stroke-width="0.7"/><rect x="4" y="8" width="28" height="20" fill="#e8d86a"/><ellipse cx="18" cy="28" rx="14" ry="6" fill="#d8c860" stroke="#b8a840" stroke-width="0.7"/><line x1="4" y1="8" x2="4" y2="28" stroke="#b8a840" stroke-width="0.7"/><line x1="32" y1="8" x2="32" y2="28" stroke="#b8a840" stroke-width="0.7"/><ellipse cx="18" cy="8" rx="14" ry="6" fill="none" stroke="#b8a840" stroke-width="0.7"/></g><g transform="translate(0,30)"><ellipse cx="18" cy="8" rx="14" ry="6" fill="#e8d86a" stroke="#b8a840" stroke-width="0.7"/><rect x="4" y="8" width="28" height="20" fill="#e8d86a"/><ellipse cx="18" cy="28" rx="14" ry="6" fill="#d8c860" stroke="#b8a840" stroke-width="0.7"/><line x1="4" y1="8" x2="4" y2="28" stroke="#b8a840" stroke-width="0.7"/><line x1="32" y1="8" x2="32" y2="28" stroke="#b8a840" stroke-width="0.7"/></g></g>
  <text x="890" y="80" font-size="22" font-weight="700" fill="#333">&#xB7;&#xB7;&#xB7;</text>
  <g transform="translate(920,42)"><g><ellipse cx="18" cy="8" rx="14" ry="6" fill="#6ab86a" stroke="#4a8a4a" stroke-width="0.7"/><rect x="4" y="8" width="28" height="20" fill="#6ab86a"/><ellipse cx="18" cy="28" rx="14" ry="6" fill="#5aa85a" stroke="#4a8a4a" stroke-width="0.7"/><line x1="4" y1="8" x2="4" y2="28" stroke="#4a8a4a" stroke-width="0.7"/><line x1="32" y1="8" x2="32" y2="28" stroke="#4a8a4a" stroke-width="0.7"/><ellipse cx="18" cy="8" rx="14" ry="6" fill="none" stroke="#4a8a4a" stroke-width="0.7"/></g><g transform="translate(0,30)"><ellipse cx="18" cy="8" rx="14" ry="6" fill="#6ab86a" stroke="#4a8a4a" stroke-width="0.7"/><rect x="4" y="8" width="28" height="20" fill="#6ab86a"/><ellipse cx="18" cy="28" rx="14" ry="6" fill="#5aa85a" stroke="#4a8a4a" stroke-width="0.7"/><line x1="4" y1="8" x2="4" y2="28" stroke="#4a8a4a" stroke-width="0.7"/><line x1="32" y1="8" x2="32" y2="28" stroke="#4a8a4a" stroke-width="0.7"/></g></g>
  <g transform="translate(975,42)"><g><ellipse cx="18" cy="8" rx="14" ry="6" fill="#a8d868" stroke="#7aaa48" stroke-width="0.7"/><rect x="4" y="8" width="28" height="20" fill="#a8d868"/><ellipse cx="18" cy="28" rx="14" ry="6" fill="#98c858" stroke="#7aaa48" stroke-width="0.7"/><line x1="4" y1="8" x2="4" y2="28" stroke="#7aaa48" stroke-width="0.7"/><line x1="32" y1="8" x2="32" y2="28" stroke="#7aaa48" stroke-width="0.7"/><ellipse cx="18" cy="8" rx="14" ry="6" fill="none" stroke="#7aaa48" stroke-width="0.7"/></g><g transform="translate(0,30)"><ellipse cx="18" cy="8" rx="14" ry="6" fill="#a8d868" stroke="#7aaa48" stroke-width="0.7"/><rect x="4" y="8" width="28" height="20" fill="#a8d868"/><ellipse cx="18" cy="28" rx="14" ry="6" fill="#98c858" stroke="#7aaa48" stroke-width="0.7"/><line x1="4" y1="8" x2="4" y2="28" stroke="#7aaa48" stroke-width="0.7"/><line x1="32" y1="8" x2="32" y2="28" stroke="#7aaa48" stroke-width="0.7"/></g></g>
  <text x="985" y="155" font-size="14" font-weight="700" text-anchor="middle" fill="#1a5a8a">Data Transfer</text>
  <line x1="738" y1="108" x2="738" y2="130" stroke="#666" stroke-width="1" marker-end="url(#arrowBlackSmall)"/><line x1="793" y1="108" x2="793" y2="130" stroke="#666" stroke-width="1" marker-end="url(#arrowBlackSmall)"/><line x1="848" y1="108" x2="848" y2="130" stroke="#666" stroke-width="1" marker-end="url(#arrowBlackSmall)"/><line x1="938" y1="108" x2="938" y2="130" stroke="#666" stroke-width="1" marker-end="url(#arrowBlackSmall)"/><line x1="993" y1="108" x2="993" y2="130" stroke="#666" stroke-width="1" marker-end="url(#arrowBlackSmall)"/>
  <use href="#dpuChip" x="720" y="132" width="36" height="36"/><use href="#dpuChip" x="775" y="132" width="36" height="36"/><use href="#dpuChip" x="830" y="132" width="36" height="36"/>
  <text x="885" y="155" font-size="16" font-weight="700" fill="#333">&#xB7;&#xB7;&#xB7;</text>
  <use href="#dpuChip" x="920" y="132" width="36" height="36"/><use href="#dpuChip" x="975" y="132" width="36" height="36"/>
  <text x="738" y="182" font-size="10" text-anchor="middle" fill="#333">DPU 0</text><text x="793" y="182" font-size="10" text-anchor="middle" fill="#333">DPU 1</text><text x="848" y="182" font-size="10" text-anchor="middle" fill="#333">DPU 2</text><text x="938" y="182" font-size="10" text-anchor="middle" fill="#333">DPU 0</text><text x="993" y="182" font-size="10" text-anchor="middle" fill="#333">DPU n</text>

  <!-- Divider -->
  <line x1="0" y1="270" x2="1300" y2="270" stroke="#666" stroke-width="1.5" stroke-dasharray="8,5"/>
  <text x="15" y="262" font-size="18" font-weight="700" font-style="italic" fill="#c0392b">Offline</text>
  <text x="15" y="286" font-size="18" font-weight="700" font-style="italic" fill="#c0392b">Online</text>

  <!-- ==================== ONLINE ==================== -->
  <rect x="30" y="305" width="285" height="195" rx="6" fill="#eee" stroke="#ccc" stroke-width="1.5" opacity="0.6"/>
  <text x="50" y="322" font-size="14" font-weight="700" fill="#333">CPU</text>
  <rect x="50" y="430" width="72" height="42" rx="4" fill="white" stroke="#666" stroke-width="1"/>
  <text x="86" y="448" font-size="10.5" font-weight="600" text-anchor="middle" fill="#333">Query</text><text x="86" y="461" font-size="10.5" font-weight="600" text-anchor="middle" fill="#333">Batch</text>
  <line x1="122" y1="451" x2="148" y2="451" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <rect x="152" y="425" width="100" height="50" rx="4" fill="#d6e8f7" stroke="#7badd4" stroke-width="1.2"/>
  <text x="202" y="447" font-size="11" font-weight="700" text-anchor="middle" fill="#1a5a8a">&#x2460;Cluster</text><text x="202" y="461" font-size="11" font-weight="700" text-anchor="middle" fill="#1a5a8a">Filtering</text>
  <line x1="202" y1="425" x2="202" y2="385" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <rect x="152" y="335" width="100" height="48" rx="4" fill="#d6e8f7" stroke="#7badd4" stroke-width="1.2"/>
  <text x="202" y="355" font-size="11" font-weight="700" text-anchor="middle" fill="#1a5a8a">&#x2461;Query</text><text x="202" y="369" font-size="11" font-weight="700" text-anchor="middle" fill="#1a5a8a">Scheduling</text>
  <line x1="252" y1="359" x2="310" y2="359" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <text x="328" y="400" font-size="20" font-weight="700" fill="#333">&#x22EE;</text>
  <line x1="310" y1="359" x2="340" y2="340" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/><line x1="310" y1="359" x2="340" y2="359" stroke="#444" stroke-width="1.2"/><line x1="335" y1="359" x2="375" y2="359" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <text x="335" y="485" font-size="12" font-weight="600" fill="#333">DPU &#xD7; n</text>
  <line x1="310" y1="359" x2="340" y2="420" stroke="#444" stroke-width="1.2"/><line x1="340" y1="420" x2="340" y2="470" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>

  <!-- DPU Processing -->
  <rect x="380" y="300" width="895" height="220" rx="6" fill="url(#blueBoxBg2)" stroke="#7badd4" stroke-width="1.5"/>
  <text x="400" y="318" font-size="14" font-weight="700" fill="#1a5a8a">DPU</text>
  <rect x="410" y="330" width="135" height="52" rx="4" fill="white" stroke="#7badd4" stroke-width="1.2"/><text x="477" y="352" font-size="12" font-weight="700" text-anchor="middle" fill="#1a5a8a">&#x2462;LUT</text><text x="477" y="368" font-size="12" font-weight="700" text-anchor="middle" fill="#1a5a8a">Construction</text>
  <line x1="545" y1="356" x2="570" y2="356" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <rect x="575" y="330" width="145" height="52" rx="4" fill="white" stroke="#7badd4" stroke-width="1.2"/><text x="647" y="352" font-size="12" font-weight="700" text-anchor="middle" fill="#1a5a8a">&#x2463;Distance</text><text x="647" y="368" font-size="12" font-weight="700" text-anchor="middle" fill="#1a5a8a">Calculation</text>
  <line x1="720" y1="356" x2="750" y2="356" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <rect x="755" y="330" width="135" height="52" rx="4" fill="white" stroke="#7badd4" stroke-width="1.2"/><text x="822" y="352" font-size="12" font-weight="700" text-anchor="middle" fill="#1a5a8a">&#x2464;TOP-K</text><text x="822" y="368" font-size="12" font-weight="700" text-anchor="middle" fill="#1a5a8a">Pruning</text>
  <line x1="890" y1="356" x2="925" y2="356" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <rect x="930" y="330" width="145" height="52" rx="4" fill="white" stroke="#7badd4" stroke-width="1.2"/><text x="1002" y="352" font-size="12" font-weight="700" text-anchor="middle" fill="#1a5a8a">&#x2465;Identifying</text><text x="1002" y="368" font-size="12" font-weight="700" text-anchor="middle" fill="#1a5a8a">Top-k</text>
  <text x="760" y="405" font-size="13" font-weight="600" font-style="italic" fill="#c0392b">Control</text>
  <line x1="647" y1="382" x2="647" y2="430" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/><line x1="647" y1="432" x2="647" y2="384" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/><line x1="822" y1="382" x2="822" y2="430" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/><line x1="822" y1="432" x2="822" y2="384" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <rect x="490" y="430" width="475" height="75" rx="5" fill="#d6e8f7" stroke="#7badd4" stroke-width="1.2"/>
  <text x="727" y="497" font-size="13" font-weight="700" text-anchor="middle" fill="#1a5a8a">Efficient Resource Management</text>
  <rect x="520" y="440" width="185" height="38" rx="4" fill="white" stroke="#7badd4" stroke-width="1"/><text x="612" y="464" font-size="12" font-weight="600" text-anchor="middle" fill="#1a5a8a">Thread Scheduling</text>
  <rect x="740" y="440" width="195" height="38" rx="4" fill="white" stroke="#7badd4" stroke-width="1"/><text x="837" y="464" font-size="12" font-weight="600" text-anchor="middle" fill="#1a5a8a">Memory Management</text>
  <text x="650" y="545" font-size="15" font-weight="400" text-anchor="middle" fill="#1a1a1a" font-family="'Times New Roman',serif">Figure 5: Overview of UpANNS. The grey blocks in each vector represent high frequency co-occurrences in the encoded vectors.</text>

  <!-- Editor handles overlay (always last) -->
  <g id="_h"></g>
</svg>
</div>
</div>

<!-- Properties Panel -->
<div id="panel">
  <h2>Properties</h2>
  <div id="p-empty" class="empty-msg">Click any element to select it.<br>Double-click text to edit.<br>Drag to move. Drag handles to resize.<br><br><b>Shortcuts:</b><br>Ctrl+Z undo &middot; Ctrl+Y redo<br>Del delete &middot; Ctrl+D duplicate</div>
  <div id="p-props" style="display:none">
    <div class="prop-row"><label>Element</label><input type="text" id="pp-tag" readonly style="opacity:.5"></div>
    <div class="prop-row" id="pr-text"><label>Text</label><textarea id="pp-text"></textarea><button class="prop-apply" onclick="applyText()">Apply</button></div>
    <div class="prop-row" id="pr-fill"><label>Fill</label><div class="color-group"><input type="color" id="pp-fill" onchange="applyFill()"><span class="color-hex" id="pp-fill-hex"></span></div></div>
    <div class="prop-row" id="pr-stroke"><label>Stroke</label><div class="color-group"><input type="color" id="pp-stroke" onchange="applyStroke()"><span class="color-hex" id="pp-stroke-hex"></span></div></div>
    <div class="prop-row" id="pr-sw"><label>Stroke width</label><div class="inline"><input type="number" id="pp-sw" step="0.5" min="0" style="width:70px"><button class="prop-apply" onclick="applySW()">Set</button></div></div>
    <div class="prop-row" id="pr-opacity"><label>Opacity</label><input type="range" id="pp-opacity" min="0" max="1" step="0.05" oninput="applyOpacity()"><span id="pp-opacity-val" style="font-size:11px;color:#94a3b8"></span></div>
    <div class="prop-row" id="pr-fs"><label>Font size</label><div class="inline"><input type="number" id="pp-fs" step="0.5" min="1" style="width:70px"><button class="prop-apply" onclick="applyFS()">Set</button></div></div>
    <div class="prop-row" id="pr-wh"><label>Width / Height</label><div class="inline"><input type="number" id="pp-w" step="1" min="1" style="width:70px" placeholder="w"><input type="number" id="pp-h" step="1" min="1" style="width:70px" placeholder="h"><button class="prop-apply" onclick="applyWH()">Set</button></div></div>
    <div class="prop-row" id="pr-xy"><label>Position x / y</label><div class="inline"><input type="number" id="pp-x" step="1" style="width:70px"><input type="number" id="pp-y" step="1" style="width:70px"><button class="prop-apply" onclick="applyXY()">Set</button></div></div>
  </div>
</div>
</div>

<div id="text-editor"><input id="te-input"></div>
<div id="toast"></div>

<script>
// ═══════════════════════════════════════════
// State
// ═══════════════════════════════════════════
const SVG_NS = 'http://www.w3.org/2000/svg';
const svg = document.getElementById('diagram');
let selected = null;
let addMode = null; // 'text' or 'rect'
let zoomLevel = 1;

// Undo / redo
const undoStack = [], redoStack = [];
const MAX_UNDO = 40;

// Drag state
let dragging = false, dragEl = null, dragStartPt = null, dragOrig = {};

// Resize state
let resizing = false, resizeEl = null, resizeIdx = -1, resizeStartPt = null, resizeOrig = {};

// ═══════════════════════════════════════════
// Helpers
// ═══════════════════════════════════════════
function toast(m) { const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1800); }

function colorHex(c) {
  if(!c) return '#000000';
  if(c.startsWith('url')||c==='none') return '#000000';
  if(c==='white') return '#ffffff';
  if(c.startsWith('#')) { if(c.length===4) return '#'+c[1]+c[1]+c[2]+c[2]+c[3]+c[3]; return c; }
  if(c.startsWith('rgb')) { const m=c.match(/\d+/g); if(m) return '#'+m.slice(0,3).map(n=>(+n).toString(16).padStart(2,'0')).join(''); }
  return c;
}

function screenToSVG(sx, sy) {
  const pt = svg.createSVGPoint(); pt.x=sx; pt.y=sy;
  return pt.matrixTransform(svg.getScreenCTM().inverse());
}

function screenToParent(el, sx, sy) {
  const pt = svg.createSVGPoint(); pt.x=sx; pt.y=sy;
  const p = el.parentElement;
  const ctm = (p && p.getScreenCTM) ? p.getScreenCTM() : svg.getScreenCTM();
  return pt.matrixTransform(ctm.inverse());
}

function getAbsBBox(el) {
  try {
    const r = el.getBoundingClientRect(), sr = svg.getBoundingClientRect();
    const vb = svg.viewBox.baseVal;
    const sx = vb.width/sr.width, sy = vb.height/sr.height;
    return { x:vb.x+(r.left-sr.left)*sx, y:vb.y+(r.top-sr.top)*sy, width:r.width*sx, height:r.height*sy };
  } catch(e) { return {x:0,y:0,width:0,height:0}; }
}

function getTranslate(el) {
  const t=el.getAttribute('transform')||'';
  const m=t.match(/translate\(\s*([\d.eE+-]+)[,\s]+([\d.eE+-]+)\s*\)/);
  return m ? {x:parseFloat(m[1]),y:parseFloat(m[2])} : {x:0,y:0};
}
function setTranslate(el,x,y) {
  const t=el.getAttribute('transform')||'';
  const nt=`translate(${x},${y})`;
  el.setAttribute('transform', t.match(/translate/) ? t.replace(/translate\([^)]+\)/,nt) : (t+' '+nt).trim());
}

// ═══════════════════════════════════════════
// Undo / Redo
// ═══════════════════════════════════════════
function saveState() {
  const clone = svg.cloneNode(true);
  const h = clone.querySelector('#_h'); if(h) h.innerHTML='';
  undoStack.push(clone.innerHTML);
  if(undoStack.length>MAX_UNDO) undoStack.shift();
  redoStack.length=0;
  updateUndoButtons();
}
function undo() {
  if(!undoStack.length) return;
  const clone = svg.cloneNode(true);
  const h2 = clone.querySelector('#_h'); if(h2) h2.innerHTML='';
  redoStack.push(clone.innerHTML);
  const state = undoStack.pop();
  restoreContent(state);
  toast('Undo');
}
function redo() {
  if(!redoStack.length) return;
  const clone = svg.cloneNode(true);
  const h2 = clone.querySelector('#_h'); if(h2) h2.innerHTML='';
  undoStack.push(clone.innerHTML);
  const state = redoStack.pop();
  restoreContent(state);
  toast('Redo');
}
function restoreContent(html) {
  deselect();
  svg.innerHTML = html;
  if(!svg.querySelector('#_h')) { const g=document.createElementNS(SVG_NS,'g'); g.id='_h'; svg.appendChild(g); }
  updateUndoButtons();
}
function updateUndoButtons() {
  document.getElementById('btn-undo').disabled = !undoStack.length;
  document.getElementById('btn-redo').disabled = !redoStack.length;
}

// ═══════════════════════════════════════════
// Selection & Handles
// ═══════════════════════════════════════════
function deselect() {
  selected = null; clearHandles();
  document.getElementById('p-empty').style.display='';
  document.getElementById('p-props').style.display='none';
  document.getElementById('btn-del').disabled=true;
  document.getElementById('btn-dup').disabled=true;
}

function select(el) {
  deselect();
  selected = el;
  showHandles(el);
  showProps(el);
  document.getElementById('btn-del').disabled=false;
  document.getElementById('btn-dup').disabled=false;
}

function clearHandles() { const g=svg.querySelector('#_h'); if(g) g.innerHTML=''; }

function showHandles(el) {
  clearHandles();
  const g = svg.querySelector('#_h'); if(!g) return;
  const bb = getAbsBBox(el);
  if(bb.width<1 && bb.height<1) return;

  // Selection outline
  const r = document.createElementNS(SVG_NS,'rect');
  r.setAttribute('x',bb.x-1); r.setAttribute('y',bb.y-1);
  r.setAttribute('width',bb.width+2); r.setAttribute('height',bb.height+2);
  r.setAttribute('fill','none'); r.setAttribute('stroke','#3b82f6');
  r.setAttribute('stroke-width','1.5'); r.setAttribute('stroke-dasharray','4,2');
  r.setAttribute('pointer-events','none');
  g.appendChild(r);

  // Resize handles for rect elements with width/height
  const tag = el.tagName.toLowerCase();
  if(tag==='rect' && el.hasAttribute('width')) {
    const HS=5;
    const cursors=['nw-resize','n-resize','ne-resize','e-resize','se-resize','s-resize','sw-resize','w-resize'];
    const pos = [
      {x:bb.x, y:bb.y}, {x:bb.x+bb.width/2, y:bb.y}, {x:bb.x+bb.width, y:bb.y},
      {x:bb.x+bb.width, y:bb.y+bb.height/2},
      {x:bb.x+bb.width, y:bb.y+bb.height}, {x:bb.x+bb.width/2, y:bb.y+bb.height},
      {x:bb.x, y:bb.y+bb.height}, {x:bb.x, y:bb.y+bb.height/2}
    ];
    pos.forEach((p,i)=>{
      const h = document.createElementNS(SVG_NS,'rect');
      h.setAttribute('x',p.x-HS/2); h.setAttribute('y',p.y-HS/2);
      h.setAttribute('width',HS); h.setAttribute('height',HS);
      h.setAttribute('fill','#3b82f6'); h.setAttribute('stroke','#fff'); h.setAttribute('stroke-width','1');
      h.style.cursor=cursors[i];
      h.dataset.hi=i; h.classList.add('resize-handle');
      g.appendChild(h);
    });
  }
}

// ═══════════════════════════════════════════
// Properties Panel
// ═══════════════════════════════════════════
function showProps(el) {
  document.getElementById('p-empty').style.display='none';
  document.getElementById('p-props').style.display='';
  const tag = el.tagName.toLowerCase();
  document.getElementById('pp-tag').value=tag;

  // Text
  const trText=document.getElementById('pr-text');
  if(tag==='text'){trText.style.display='';document.getElementById('pp-text').value=el.textContent.trim();}else trText.style.display='none';

  // Fill
  const trFill=document.getElementById('pr-fill');
  const fill=el.getAttribute('fill');
  if(fill&&fill!=='none'&&!fill.startsWith('url')){trFill.style.display='';const hx=colorHex(fill);document.getElementById('pp-fill').value=hx;document.getElementById('pp-fill-hex').textContent=hx;}else trFill.style.display='none';

  // Stroke
  const trStroke=document.getElementById('pr-stroke');
  const stroke=el.getAttribute('stroke');
  if(stroke&&stroke!=='none'){trStroke.style.display='';const hx=colorHex(stroke);document.getElementById('pp-stroke').value=hx;document.getElementById('pp-stroke-hex').textContent=hx;}else trStroke.style.display='none';

  // Stroke width
  const trSW=document.getElementById('pr-sw');
  const sw=el.getAttribute('stroke-width');
  if(sw){trSW.style.display='';document.getElementById('pp-sw').value=parseFloat(sw);}else trSW.style.display='none';

  // Opacity
  const trOp=document.getElementById('pr-opacity');
  trOp.style.display='';
  const op=el.getAttribute('opacity')||'1';
  document.getElementById('pp-opacity').value=parseFloat(op);
  document.getElementById('pp-opacity-val').textContent=op;

  // Font size
  const trFS=document.getElementById('pr-fs');
  if(tag==='text'){trFS.style.display='';document.getElementById('pp-fs').value=parseFloat(el.getAttribute('font-size')||'12');}else trFS.style.display='none';

  // Width/Height
  const trWH=document.getElementById('pr-wh');
  if(tag==='rect'&&el.hasAttribute('width')){trWH.style.display='';document.getElementById('pp-w').value=parseFloat(el.getAttribute('width'));document.getElementById('pp-h').value=parseFloat(el.getAttribute('height'));}else trWH.style.display='none';

  // Position
  const trXY=document.getElementById('pr-xy');
  if(el.hasAttribute('x')&&el.hasAttribute('y')){trXY.style.display='';document.getElementById('pp-x').value=parseFloat(el.getAttribute('x'));document.getElementById('pp-y').value=parseFloat(el.getAttribute('y'));}
  else if(el.hasAttribute('cx')&&el.hasAttribute('cy')){trXY.style.display='';document.getElementById('pp-x').value=parseFloat(el.getAttribute('cx'));document.getElementById('pp-y').value=parseFloat(el.getAttribute('cy'));}
  else trXY.style.display='none';
}

// Apply property changes
function applyText(){if(!selected||selected.tagName!=='text')return;saveState();selected.textContent=document.getElementById('pp-text').value;toast('Text updated');}
function applyFill(){if(!selected)return;saveState();const c=document.getElementById('pp-fill').value;selected.setAttribute('fill',c);document.getElementById('pp-fill-hex').textContent=c;toast('Fill updated');}
function applyStroke(){if(!selected)return;saveState();const c=document.getElementById('pp-stroke').value;selected.setAttribute('stroke',c);document.getElementById('pp-stroke-hex').textContent=c;toast('Stroke updated');}
function applySW(){if(!selected)return;saveState();selected.setAttribute('stroke-width',document.getElementById('pp-sw').value);toast('Stroke width updated');}
function applyOpacity(){if(!selected)return;const v=document.getElementById('pp-opacity').value;selected.setAttribute('opacity',v);document.getElementById('pp-opacity-val').textContent=parseFloat(v).toFixed(2);}
function applyFS(){if(!selected||selected.tagName!=='text')return;saveState();selected.setAttribute('font-size',document.getElementById('pp-fs').value);showHandles(selected);toast('Font size updated');}
function applyWH(){if(!selected||selected.tagName!=='rect')return;saveState();selected.setAttribute('width',document.getElementById('pp-w').value);selected.setAttribute('height',document.getElementById('pp-h').value);showHandles(selected);toast('Size updated');}
function applyXY(){if(!selected)return;saveState();const x=document.getElementById('pp-x').value,y=document.getElementById('pp-y').value;if(selected.hasAttribute('x')){selected.setAttribute('x',x);selected.setAttribute('y',y);}else if(selected.hasAttribute('cx')){selected.setAttribute('cx',x);selected.setAttribute('cy',y);}showHandles(selected);toast('Position updated');}

// ═══════════════════════════════════════════
// Click / Double-click
// ═══════════════════════════════════════════
svg.addEventListener('click', function(e) {
  const el = e.target;
  if(el.closest('#_h')) return; // handle click handled separately
  if(el.closest('defs')||el.closest('marker')||el.closest('symbol')) return;

  // Add mode
  if(addMode) {
    saveState();
    const pt = screenToSVG(e.clientX, e.clientY);
    const hg = svg.querySelector('#_h');
    if(addMode==='text') {
      const t = document.createElementNS(SVG_NS,'text');
      t.setAttribute('x',pt.x); t.setAttribute('y',pt.y);
      t.setAttribute('font-size','14'); t.setAttribute('fill','#333');
      t.textContent='New Text';
      svg.insertBefore(t, hg);
      select(t);
    } else if(addMode==='rect') {
      const r = document.createElementNS(SVG_NS,'rect');
      r.setAttribute('x',pt.x-40); r.setAttribute('y',pt.y-20);
      r.setAttribute('width','80'); r.setAttribute('height','40');
      r.setAttribute('rx','4'); r.setAttribute('fill','#d6e8f7');
      r.setAttribute('stroke','#7badd4'); r.setAttribute('stroke-width','1.2');
      svg.insertBefore(r, hg);
      select(r);
    }
    addMode=null;
    document.getElementById('btn-addtext').classList.remove('active');
    document.getElementById('btn-addrect').classList.remove('active');
    toast('Element added');
    return;
  }

  if(el===svg) { deselect(); return; }
  select(el);
});

// Double-click text → inline edit
svg.addEventListener('dblclick', function(e) {
  const el = e.target;
  if(el.tagName!=='text') return;
  e.preventDefault();
  const editor=document.getElementById('text-editor'), input=document.getElementById('te-input');
  const rect=el.getBoundingClientRect();
  editor.style.left=rect.left+'px'; editor.style.top=(rect.top-4)+'px'; editor.style.display='block';
  input.value=el.textContent.trim();
  input.style.fontSize=(rect.height*.85)+'px';
  input.focus(); input.select();
  function finish(){saveState();el.textContent=input.value;editor.style.display='none';input.removeEventListener('blur',finish);input.removeEventListener('keydown',onKey);if(selected===el)showProps(el);toast('Text updated');}
  function onKey(ev){if(ev.key==='Enter'){ev.preventDefault();finish();}if(ev.key==='Escape')editor.style.display='none';}
  input.addEventListener('blur',finish);
  input.addEventListener('keydown',onKey);
});

document.addEventListener('click', function(e) {
  if(!e.target.closest('#canvas')&&!e.target.closest('#panel')&&!e.target.closest('#toolbar')) deselect();
});

// ═══════════════════════════════════════════
// Drag to Move
// ═══════════════════════════════════════════
svg.addEventListener('mousedown', function(e) {
  if(e.button!==0) return;
  const el = e.target;

  // Resize handle?
  if(el.classList.contains('resize-handle') && selected) {
    e.preventDefault();
    resizing=true; resizeEl=selected; resizeIdx=parseInt(el.dataset.hi);
    resizeStartPt=screenToParent(resizeEl, e.clientX, e.clientY);
    resizeOrig={x:parseFloat(resizeEl.getAttribute('x')),y:parseFloat(resizeEl.getAttribute('y')),w:parseFloat(resizeEl.getAttribute('width')),h:parseFloat(resizeEl.getAttribute('height'))};
    saveState();
    return;
  }

  if(el.closest('#_h')||el.closest('defs')||el===svg) return;

  const tag = el.tagName.toLowerCase();
  // Decide what to drag
  let target = el;
  // For groups, drag the group
  if(tag==='g' || (el.parentElement && el.parentElement.tagName==='g' && el.parentElement!==svg && !el.parentElement.closest('defs'))) {
    target = (tag==='g') ? el : el.parentElement;
    // If it's a deeply nested group, go up to the highest non-svg group
    while(target.parentElement && target.parentElement.tagName==='g' && target.parentElement!==svg && !target.parentElement.id) {
      target = target.parentElement;
    }
  }

  // Determine if draggable
  const tTag = target.tagName.toLowerCase();
  const canDrag = (tTag==='text' && target.hasAttribute('x'))
    || (tTag==='rect' && target.hasAttribute('x') && parseFloat(target.getAttribute('width'))>14)
    || (tTag==='g' && target.getAttribute('transform'));

  if(!canDrag) return;

  e.preventDefault();
  dragging=true; dragEl=target;
  dragStartPt=screenToParent(target, e.clientX, e.clientY);

  if(tTag==='g') {
    const t=getTranslate(target);
    dragOrig={tx:t.x, ty:t.y};
  } else {
    dragOrig={x:parseFloat(target.getAttribute('x')), y:parseFloat(target.getAttribute('y'))};
  }
});

window.addEventListener('mousemove', function(e) {
  // Resize
  if(resizing && resizeEl) {
    const cur = screenToParent(resizeEl, e.clientX, e.clientY);
    const dx=cur.x-resizeStartPt.x, dy=cur.y-resizeStartPt.y;
    let {x,y,w,h}=resizeOrig;
    let nx=x,ny=y,nw=w,nh=h;
    const i=resizeIdx;
    if([0,6,7].includes(i)){nx=x+dx;nw=w-dx;}
    if([2,3,4].includes(i)){nw=w+dx;}
    if([0,1,2].includes(i)){ny=y+dy;nh=h-dy;}
    if([4,5,6].includes(i)){nh=h+dy;}
    if(nw<8){if([0,6,7].includes(i))nx=x+w-8;nw=8;}
    if(nh<8){if([0,1,2].includes(i))ny=y+h-8;nh=8;}
    resizeEl.setAttribute('x',nx);resizeEl.setAttribute('y',ny);
    resizeEl.setAttribute('width',nw);resizeEl.setAttribute('height',nh);
    showHandles(resizeEl);
    if(selected===resizeEl) showProps(resizeEl);
    return;
  }
  // Drag
  if(!dragging||!dragEl) return;
  const cur = screenToParent(dragEl, e.clientX, e.clientY);
  const dx=cur.x-dragStartPt.x, dy=cur.y-dragStartPt.y;
  if(dragEl.tagName==='g') {
    setTranslate(dragEl, dragOrig.tx+dx, dragOrig.ty+dy);
  } else {
    dragEl.setAttribute('x', dragOrig.x+dx);
    dragEl.setAttribute('y', dragOrig.y+dy);
  }
  showHandles(dragEl);
  if(selected===dragEl) showProps(dragEl);
});

window.addEventListener('mouseup', function() {
  if(dragging) { dragging=false; if(dragEl){saveState();} dragEl=null; }
  if(resizing) { resizing=false; resizeEl=null; resizeIdx=-1; }
});

// ═══════════════════════════════════════════
// Delete / Duplicate
// ═══════════════════════════════════════════
function deleteSelected() {
  if(!selected) return;
  saveState();
  selected.remove();
  deselect();
  toast('Deleted');
}

function duplicateSelected() {
  if(!selected) return;
  saveState();
  const clone = selected.cloneNode(true);
  // Offset the clone slightly
  if(clone.hasAttribute('x')) clone.setAttribute('x', parseFloat(clone.getAttribute('x'))+10);
  if(clone.hasAttribute('y')) clone.setAttribute('y', parseFloat(clone.getAttribute('y'))+10);
  if(clone.tagName==='g' && clone.getAttribute('transform')) {
    const t=getTranslate(clone);
    setTranslate(clone, t.x+10, t.y+10);
  }
  const hg = svg.querySelector('#_h');
  svg.insertBefore(clone, hg);
  select(clone);
  toast('Duplicated');
}

// ═══════════════════════════════════════════
// Zoom
// ═══════════════════════════════════════════
function setZoom(z) {
  zoomLevel = Math.max(0.25, Math.min(4, z));
  const vw=1300/zoomLevel, vh=560/zoomLevel;
  const vx=(1300-vw)/2, vy=(560-vh)/2;
  svg.setAttribute('viewBox', `${vx} ${vy} ${vw} ${vh}`);
  document.getElementById('zoom-display').textContent=Math.round(zoomLevel*100)+'%';
  if(selected) showHandles(selected);
}

// ═══════════════════════════════════════════
// Download
// ═══════════════════════════════════════════
function getCleanSVG() {
  const clone=svg.cloneNode(true);
  const h=clone.querySelector('#_h'); if(h) h.remove();
  clone.removeAttribute('id');
  clone.setAttribute('viewBox','0 0 1300 560');
  return clone;
}
function downloadHTML() {
  const c=getCleanSVG();
  const html=`<!DOCTYPE html>\n<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Diagram</title><link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet"><style>*{margin:0;padding:0;box-sizing:border-box}body{background:#fff;display:flex;justify-content:center;align-items:center;min-height:100vh;padding:10px;font-family:'Source Sans Pro',serif}.container{width:100%;max-width:1300px}svg text{font-family:'Source Sans Pro','Times New Roman',serif}</style></head><body><div class="container">${c.outerHTML}</div></body></html>`;
  const b=new Blob([html],{type:'text/html'}); const u=URL.createObjectURL(b);
  const a=document.createElement('a'); a.href=u; a.download='diagram.html'; a.click(); URL.revokeObjectURL(u); toast('HTML downloaded');
}
function downloadSVG() {
  const c=getCleanSVG();
  const b=new Blob([c.outerHTML],{type:'image/svg+xml'}); const u=URL.createObjectURL(b);
  const a=document.createElement('a'); a.href=u; a.download='diagram.svg'; a.click(); URL.revokeObjectURL(u); toast('SVG downloaded');
}
function resetAll() { if(!confirm('Reset all changes?')) return; location.reload(); }

// ═══════════════════════════════════════════
// Keyboard shortcuts
// ═══════════════════════════════════════════
document.addEventListener('keydown', function(e) {
  if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA') return;
  if(e.ctrlKey||e.metaKey) {
    if(e.key==='z'){e.preventDefault();undo();}
    if(e.key==='y'){e.preventDefault();redo();}
    if(e.key==='d'){e.preventDefault();duplicateSelected();}
  }
  if((e.key==='Delete'||e.key==='Backspace')&&selected){e.preventDefault();deleteSelected();}
  if(e.key==='Escape'){deselect();addMode=null;document.getElementById('btn-addtext').classList.remove('active');document.getElementById('btn-addrect').classList.remove('active');}
});

// Add-mode button toggles
document.getElementById('btn-addtext').addEventListener('click',function(){
  addMode=addMode==='text'?null:'text';
  this.classList.toggle('active',addMode==='text');
  document.getElementById('btn-addrect').classList.remove('active');
});
document.getElementById('btn-addrect').addEventListener('click',function(){
  addMode=addMode==='rect'?null:'rect';
  this.classList.toggle('active',addMode==='rect');
  document.getElementById('btn-addtext').classList.remove('active');
});

// Ctrl+scroll zoom
document.getElementById('canvas-wrap').addEventListener('wheel', function(e) {
  if(e.ctrlKey||e.metaKey){e.preventDefault();setZoom(zoomLevel+(e.deltaY<0?.15:-.15));}
},{passive:false});

// Opacity: save state on mouseup (not every input event)
document.getElementById('pp-opacity').addEventListener('change', function(){saveState();});
</script>
</body>
</html>
